#lang racket

(require try-catch)
(require (prefix-in startup: "infrabel/gui/startup.rkt"))
(require (prefix-in socket: "infrabel/udp/socket.rkt"))
(require (prefix-in server: "infrabel/tcp/server.rkt"))
(require (prefix-in adm&dbg: "infrabel/gui/admin-debugger.rkt"))
(require "infrabel/interface.rkt")

(define startup-callback
  (λ (type host port a&d?) (startup-server type host port a&d?)))
(define status-callback
  (λ (callback) (set! status-callback callback)))
(define server (void))

(define (close-on-error)
  (socket:stop))

(define infra 'dummy)
(define gui 'dummy)

(define (startup-server type host port a&d?)
  (let/cc return
    ;; starting message
    (send status-callback insert
          "Startup of the INFRABEL control software for modal railways.\n\n")
    ;; socket connection
    (send status-callback insert "Connecting to the modal railway ... : ")
    (try
     ((socket:config 'sim 'hardware)
      (socket:start))
     (catch (exn:fail? (send status-callback insert
                             "\nERROR: could not connect to modal railway\n\n")
                       (close-on-error) (return #f) e)))
    (send status-callback insert "SUCCES\n")
    ;; server connection
    (send status-callback insert "Setting up server ... : ")
    (try
     ;##########################################################################
     ((server:start-server host (string->number port)) ; NOT CONNECTED TO INFRA!
      (set! infra (new infrabel:infrabel% (connection (new socket:socket%)))))
     (catch (exn:fail?
             (send
              status-callback insert
              (string-append*
               `("\nERROR: could not setup server on " ,host ":" ,port "\n\n")))
             (close-on-error) (return #f) e)))
    (send
     status-callback insert "SUCCES\n")

    ;; starting admin & debugger
    (send status-callback insert "Setting up admin and debugger panel ... : ")
    (try
     ((when a&d?
        (set! gui (make-object adm&dbg:gui% infra))
        (send gui show #t)))
     (catch (exn:fail?
             (send status-callback insert
                   "\nERROR: could not setup admin and debugger panel \n\n")
             (close-on-error) (display e) (return #f) e)))
    (send status-callback insert "SUCCES\n")
    
    ;; ending message 
    (send status-callback insert
          (string-append*
           `("\nStartup succesful, server on  >>> " ,host ":" ,port " <<<")))
    (send status-callback insert "\nYou may close this window now.\n\n")))

(startup startup-callback status-callback)